{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "999aaffe-293e-4625-bb3c-499fb7fe6276",
   "metadata": {},
   "outputs": [],
   "source": [
    "# SUBIR ARCHIVOS DEL PC AL SERVIDOR \n",
    "\n",
    "scp \"C:\\Users\\pmorales\\Downloads\\archivo_comprimido_1044.zip\" yordonez3@bio-compjord01:/home/yordonez3/Danny_OV_WES/concatenated_fastq/\n",
    "scp \"C:\\Users\\pmorales\\Downloads\\archivo_comprimido_1044.zip\" yordonez3@130.207.66.26:/home/yordonez3/Danny_OV_WES/concatenated_fastq_/\n",
    "scp \"C:\\Users\\pmorales\\Downloads\\annovar.latest.tar\"  yordonez3@bio-compjord01:/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES/Mutect2_filtered/normalized/annovar/\n",
    "\n",
    "# SUBIR UN UNICO ARCHIVO DEL PC AL SERVIDOR \n",
    "scp \"C:\\Users\\pmorales\\Downloads\\OVARIO\\*\" yordonez3@130.207.66.26:/home/yordonez3/Danny_OV_WES/concatenated_fastq/OVARIO/\n",
    "\n",
    "# Descomprimir el completo \n",
    "\n",
    "UNZIP_DISABLE_ZIPBOMB_DETECTION=TRUE unzip archivo_comprimido_896.zip -d /home/yordonez/Danny_OV_WES/\n",
    "\n",
    "# Para pasar de fastq.gz a fastq\n",
    "gunzip *fastq.gz\n",
    "\n",
    "### Si es necesario concatenar varios archivos de la misma muestra:\n",
    "\n",
    "###EJEMPLO:. concatenar todo\"CO-H,243121\"*\n",
    "cat _L*_1.fastq > CO-E_243121_all_R1_fastq\n",
    "cat \"CO-E,275235\"*_L*_1.fastq > CO-E_275235_all_R1_fastq"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f06b3d4f-2044-451c-bd63-618823db6a10",
   "metadata": {},
   "outputs": [],
   "source": [
    "1. ### FASTQC raw\n",
    "conda activate fastqc_env\n",
    "\n",
    "fastqc -o /home/yordonez3/Danny_OV_WES/concatenated_fastq/*.fastq\n",
    "\n",
    "#### Para correr muestras faltantes\n",
    "\n",
    "# Activar el entorno de conda\n",
    "conda activate fastqc_env\n",
    "\n",
    "output_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/fastqc_results\"\n",
    "input_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/OVARIO\"\n",
    "\n",
    "# Iterar sobre los archivos .fastq.gz\n",
    "for file in $input_dir/*_all_R2.fastq; do\n",
    "    # Obtener el nombre del archivo sin la extensi√≥n\n",
    "    filename=$(basename \"$file\" .fastq)\n",
    "\n",
    "    # Verificar si los archivos de salida ya existen\n",
    "    if [[ ! -f \"$output_dir/$filename\"_fastqc.html && ! -f \"$output_dir/$filename\"_fastqc.zip ]]; then\n",
    "        # Si no existen los archivos de salida, ejecutar fastqc\n",
    "        echo \"Procesando $filename...\"\n",
    "        fastqc -o \"$output_dir\" \"$file\"\n",
    "    else\n",
    "        # Si los archivos de salida ya existen, saltar esta muestra\n",
    "        echo \"La muestra $filename ya ha sido procesada. Saltando...\"\n",
    "    fi\n",
    "done\n",
    "\n",
    "2. ### MULTIQC raw\n",
    "multiqc /home/yordonez3/Danny_OV_WES/concatenated_fastq/fastqc_results -o /home/yordonez3/Danny_OV_WES/concatenated_fastq/multiqc_report\n",
    "\n",
    "3. ### Descargar el archivo en mi Powershell\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "2248eb2e-9cb5-4bfb-84ea-2cbeb093d8cc",
   "metadata": {},
   "outputs": [],
   "source": [
    "Nuevo script\n",
    "#### ALINEAMIENTO\n",
    "\n",
    "# 1. Indexar gemona de referencia \n",
    "#Toda la info del genoma : http://hgdownload.cse.ucsc.edu/goldenpath/hg38/bigZips/\n",
    "        \n",
    "# para descargarlo\n",
    "wget http://hgdownload.cse.ucsc.edu/goldenpath/hg38/bigZips/hg38.fa.gz\n",
    "# Descomprimir el genoma\n",
    "gunzip hg38.fa.gz\n",
    "#Tama√±o del archivo\n",
    "du -h hg38.fa #para saber el peso (3.1GB)\n",
    "\n",
    "# descargar el archivo de anotaciones\n",
    "wget http://hgdownload.cse.ucsc.edu/goldenpath/hg38/bigZips/genes/hg38.refGene.gtf.gz\n",
    "gunzip hg38.refGene.gtf.gz\n",
    "\n",
    "#Para crear el index\n",
    "# Entrar a la carpeta de salida y crear un enlace hacia donde esta el genoma\n",
    "ln -s /home/wovalle3/Samples/GRCh38_Gencode31/hg38.fa .\n",
    "ln -s /home/yordonez3/Danny_OV_WES/GRCh38_Gencode31/hg38.fa .\n",
    "\n",
    "#Indexar\n",
    "bwa index hg38.fa\n",
    "\n",
    "# 2. Correr el alineamiento\n",
    "\n",
    "#Alinear muestra por muestra al genoma de referencia: \n",
    "#!/bin/bash\n",
    "\n",
    "# Definir rutas\n",
    "FASTQ_DIR=\"bam_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/BWA_data_faltantes\" \n",
    "REF_GENOME=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/hg38.fa\"\n",
    "OUTPUT_DIR=\"$FASTQ_DIR\"\n",
    "\n",
    "# Especificar manualmente el nombre de la muestra si es necesario (sin _R1.fastq ni _R2.fastq)\n",
    "MUESTRA=\"CO-E_236609\"\n",
    "\n",
    "# Definir archivos de entrada\n",
    "R1=\"${FASTQ_DIR}/${MUESTRA}_R1.fastq\" ## tener cuidado si es .fastq o _fastq\n",
    "R2=\"${FASTQ_DIR}/${MUESTRA}_R2.fastq\"\n",
    "\n",
    "# Definir archivo de salida\n",
    "output_bam=\"$OUTPUT_DIR/${MUESTRA}.bam\"\n",
    "\n",
    "echo \"Procesando muestra: $MUESTRA\"\n",
    "\n",
    "# Ejecutar BWA\n",
    "bwa mem -t 8 \"$REF_GENOME\" \"$R1\" \"$R2\" > \"$output_bam\"\n",
    "\n",
    "# Verificaci√≥n\n",
    "if [ $? -eq 0 ]; then\n",
    "    echo \"‚úÖ BWA completado correctamente para la muestra $MUESTRA\"\n",
    "else\n",
    "    echo \"‚ùå Error en BWA para la muestra $MUESTRA\"\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "2bda81f4-5f21-46b0-b1f6-97b418904989",
   "metadata": {
    "collapsed": true,
    "jupyter": {
     "outputs_hidden": true
    },
    "scrolled": true
   },
   "outputs": [
    {
     "ename": "SyntaxError",
     "evalue": "invalid syntax (3724866200.py, line 10)",
     "output_type": "error",
     "traceback": [
      "\u001b[0;36m  Cell \u001b[0;32mIn[2], line 10\u001b[0;36m\u001b[0m\n\u001b[0;31m    samples=($(ls \"${input_dir}\"/*.bam | xargs -n 1 basename | sed 's/.bam//'))\u001b[0m\n\u001b[0m             ^\u001b[0m\n\u001b[0;31mSyntaxError\u001b[0m\u001b[0;31m:\u001b[0m invalid syntax\n"
     ]
    }
   ],
   "source": [
    "## PICARD\n",
    "\n",
    "#para obtener el archivo de referencia:\n",
    "## wget http://hgdownload.cse.ucsc.edu/goldenPath/hg38/database/refFlat.txt.gz\n",
    "\n",
    "input_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/OVARIO/bwa_data\"\n",
    "output_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq//OVARIO/bwa_data\"\n",
    "reference_genome=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/hg38.fa\"\n",
    "\n",
    "samples=($(ls \"${input_dir}\"/*.bam | xargs -n 1 basename | sed 's/.bam//'))\n",
    "\n",
    "# Bucle para procesar cada muestra\n",
    "for sample_name in \"${samples[@]}\"; do\n",
    "    input_bam=\"${input_dir}/${sample_name}.bam\"\n",
    "    sorted_bam=\"${output_dir}/${sample_name}_sorted.bam\"\n",
    "    output_file=\"${output_dir}/${sample_name}_alignment_Metrics.txt\"\n",
    "\n",
    "    # Ordenar el archivo BAM\n",
    "    java -Xmx64G -jar /home/yordonez3/picard/picard.jar SortSam \\\n",
    "        INPUT=\"$input_bam\" \\\n",
    "        OUTPUT=\"$sorted_bam\" \\\n",
    "        SORT_ORDER=coordinate\n",
    "\n",
    "    # Recopilar m√©tricas de alineaci√≥n\n",
    "    java -Xmx64G -jar /home/yordonez3/picard/picard.jar CollectAlignmentSummaryMetrics \\\n",
    "        REFERENCE_SEQUENCE=\"$reference_genome\" \\\n",
    "        INPUT=\"$sorted_bam\" \\\n",
    "        OUTPUT=\"$output_file\"\n",
    "\n",
    "    echo \"Picard completado para la muestra $sample_name\"\n",
    "done\n",
    "\n",
    "### si faltan muestras por procesar:\n",
    "\n",
    "input_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/BWA_data_faltantes\"\n",
    "output_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/picard_exo\"\n",
    "reference_genome=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/hg38.fa\"\n",
    "\n",
    "samples=($(ls \"${input_dir}\"/*.bam | xargs -n 1 basename | sed 's/.bam//'))\n",
    "\n",
    "# Bucle para procesar cada muestra\n",
    "for sample_name in \"${samples[@]}\"; do\n",
    "    input_bam=\"${input_dir}/${sample_name}.bam\"\n",
    "    sorted_bam=\"${output_dir}/${sample_name}_sorted.bam\"\n",
    "    output_file=\"${output_dir}/${sample_name}_alignment_Metrics.txt\"\n",
    "\n",
    "    # Verificar si ya se proces√≥ la muestra\n",
    "    if [[ -f \"$output_file\" ]]; then\n",
    "        echo \"‚ö†Ô∏è  Muestra $sample_name ya fue procesada. Saltando...\"\n",
    "        continue\n",
    "    fi\n",
    "\n",
    "    echo \"üîÑ Procesando muestra: $sample_name\"\n",
    "\n",
    "# Ordenar el archivo BAM\n",
    "    java -Xmx64G -jar /home/yordonez3/picard/picard.jar SortSam \\\n",
    "        INPUT=\"$input_bam\" \\\n",
    "        OUTPUT=\"$sorted_bam\" \\\n",
    "        SORT_ORDER=coordinate\n",
    "\n",
    "    # Recopilar m√©tricas de alineaci√≥n\n",
    "    java -Xmx64G -jar /home/yordonez3/picard/picard.jar CollectAlignmentSummaryMetrics \\\n",
    "        REFERENCE_SEQUENCE=\"$reference_genome\" \\\n",
    "        INPUT=\"$sorted_bam\" \\\n",
    "        OUTPUT=\"$output_file\"\n",
    "\n",
    "    echo \"‚úÖ Picard completado para la muestra $sample_name\"\n",
    "done"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "748621dc-74f2-4f8c-962b-62288c80df75",
   "metadata": {},
   "outputs": [],
   "source": [
    "#### MARCAR ARCHIVOS BAM\n",
    "\n",
    "bam_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/BWA_data_faltantes/CO-H_302244_all.bam\"\n",
    "picard=\"/home/yordonez3/picard/picard.jar\"\n",
    "java=\"/home/yordonez3/jdk-21.0.2/bin/java\"\n",
    "output_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/OVARIO/bwa_data\"\n",
    "\n",
    "for bam_file in \"${bam_dir}\"/*.bam; do\n",
    "    base_name=$(basename \"$bam_file\" .bam)\n",
    "    output_bam=\"${output_dir}/${base_name}-wRG.bam\"\n",
    "\n",
    "    # Si el archivo ya existe, lo saltamos\n",
    "    if [ -f \"$output_bam\" ]; then\n",
    "        echo \"‚ö†Ô∏è  Archivo $output_bam ya existe, saltando...\"\n",
    "        continue\n",
    "    fi\n",
    "\n",
    "    # Ejecutar Picard AddOrReplaceReadGroups\n",
    "    \"$java\" -jar \"$picard\" AddOrReplaceReadGroups \\\n",
    "        I=\"$bam_file\" \\\n",
    "        O=\"$output_bam\" \\\n",
    "        SO=coordinate \\\n",
    "        CREATE_INDEX=true \\\n",
    "        RGID=K00171 \\\n",
    "        RGLB=SureSelectXT \\\n",
    "        RGPL=illumina \\\n",
    "        RGPU=K00171 \\\n",
    "        RGSM=\"$base_name\"\n",
    "\n",
    "    echo \"‚úÖ Archivo ${base_name}.bam ha sido procesado.\"\n",
    "done\n",
    "\n",
    "echo \"‚úÖ Todos los BAM fueron procesados (o ya estaban listos).\"\n",
    "\n",
    "#####uns asolamuestra\n",
    "\n",
    "bam_file=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/OVARIO/bwa_data/CO-H_302244_all.bam\"\n",
    "picard=\"/home/yordonez3/picard/picard.jar\"\n",
    "java=\"/home/yordonez3/jdk-21.0.2/bin/java\"\n",
    "output_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/OVARIO/bwa_data\"\n",
    "\n",
    "mkdir -p \"$output_dir\"\n",
    "\n",
    "base_name=$(basename \"$bam_file\" .bam)\n",
    "output_bam=\"${output_dir}/${base_name}-wRG.bam\"\n",
    "\n",
    "if [ -f \"$output_bam\" ]; then\n",
    "    echo \"‚ö†Ô∏è  Archivo $output_bam ya existe, saltando procesamiento.\"\n",
    "else\n",
    "    \"$java\" -jar \"$picard\" AddOrReplaceReadGroups \\\n",
    "        I=\"$bam_file\" \\\n",
    "        O=\"$output_bam\" \\\n",
    "        SO=coordinate \\\n",
    "        CREATE_INDEX=true \\\n",
    "        RGID=K00171 \\\n",
    "        RGLB=SureSelectXT \\\n",
    "        RGPL=illumina \\\n",
    "        RGPU=K00171 \\\n",
    "        RGSM=\"$base_name\"\n",
    "\n",
    "    echo \"‚úÖ Archivo ${base_name}.bam ha sido procesado.\"\n",
    "fi"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "885f9488-f403-459b-9a58-4b1bf58f9542",
   "metadata": {},
   "outputs": [],
   "source": [
    "### ORDENAR ARCHIVOS: \n",
    "\n",
    "bam_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/OVARIO/bwa_data\"\n",
    "picard=\"/home/yordonez3/picard/picard.jar\"\n",
    "java=\"/home/yordonez3/jdk-21.0.2/bin/java\"\n",
    "output_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/OVARIO/bwa_data\"\n",
    "\n",
    "for bam_file in \"${bam_dir}\"/*-wRG.bam; do\n",
    "    base_name=$(basename \"$bam_file\" -wRG.bam)\n",
    "    sorted_bam=\"${base_name}-sorted.bam\"\n",
    "    \n",
    "    # Ordenar los BAMs por coordenadas\n",
    "    \"$java\" -jar \"$picard\" SortSam \\\n",
    "         I=\"$bam_file\" \\\n",
    "         O=\"$output_dir/$sorted_bam\" \\\n",
    "         SORT_ORDER=coordinate\n",
    "    \n",
    "    echo \"Archivo $bam_file ordenado como $sorted_bam.\"\n",
    "done\n",
    "\n",
    "### Si faltan muestras\n",
    "\n",
    "bam_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES\"\n",
    "picard=\"/home/yordonez3/picard/picard.jar\"\n",
    "java=\"/home/yordonez3/jdk-21.0.2/bin/java\"\n",
    "output_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES\"\n",
    "\n",
    "for bam_file in \"${bam_dir}\"/*-wRG.bam; do\n",
    "    base_name=$(basename \"$bam_file\" -wRG.bam)\n",
    "    sorted_bam=\"${base_name}-sorted.bam\"\n",
    "    output_bam_path=\"${output_dir}/${sorted_bam}\"\n",
    "    \n",
    "    # Saltar si el archivo ordenado ya existe\n",
    "    if [ -f \"$output_bam_path\" ]; then\n",
    "        echo \"‚ö†Ô∏è Archivo ordenado $sorted_bam ya existe, saltando...\"\n",
    "        continue\n",
    "    fi\n",
    "\n",
    "    # Ordenar los BAMs por coordenadas\n",
    "    \"$java\" -jar \"$picard\" SortSam \\\n",
    "         I=\"$bam_file\" \\\n",
    "         O=\"$output_bam_path\" \\\n",
    "         SORT_ORDER=coordinate\n",
    "    \n",
    "    echo \"‚úÖ Archivo $bam_file ordenado como $sorted_bam.\"\n",
    "done"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d17e3713-95e1-475e-ac8b-3950c5df40d6",
   "metadata": {},
   "outputs": [],
   "source": [
    "## MARCAR DUPLICADOS-\n",
    "\n",
    "bam_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES/bwa_data\"\n",
    "picard=\"/home/yordonez3/picard/picard.jar\"\n",
    "java=\"/home/yordonez3/jdk-21.0.2/bin/java\"\n",
    "output_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES/bwa_data\"\n",
    "\n",
    "for bam_file in \"${bam_dir}\"/*-sorted.bam; do\n",
    "    base_name=$(basename \"$bam_file\" -sorted.bam)\n",
    "    salida=\"${base_name}-noDups.bam\"\n",
    "    \n",
    "    # Verifica si ya existe el archivo de salida, si existe, saltar\n",
    "    if [ -f \"$output_dir/$salida\" ]; then\n",
    "        echo \"Archivo $salida ya existe, saltando...\"\n",
    "        continue\n",
    "    fi\n",
    "\n",
    "    # Marcar duplicados\n",
    "    \"$java\" -jar \"$picard\" MarkDuplicates \\\n",
    "         I=\"$bam_file\" \\\n",
    "         O=\"$output_dir/$salida\" \\\n",
    "         M=\"$output_dir/${salida%.bam}.metrics\" \\\n",
    "         REMOVE_DUPLICATES=true\n",
    "         \n",
    "    echo \"Duplicados marcados para ${base_name}.\"\n",
    "done\n",
    "\n",
    "ls-lh -sorted.bam\n",
    "\n",
    "#### OTRAS MUESTARS\n",
    "bam_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/VARIANTES/archivos_pendientes\"\n",
    "picard=\"/home/yordonez3/picard/picard.jar\"\n",
    "java=\"/home/yordonez3/jdk-21.0.2/bin/java\"\n",
    "output_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/VARIANTES/archivos_pendientes\"\n",
    "\n",
    "for bam_file in \"${bam_dir}\"/*-sorted.bam; do\n",
    "    base_name=$(basename \"$bam_file\" -sorted.bam)\n",
    "    salida=\"${base_name}-noDups.bam\"\n",
    "    \n",
    "    # Verifica si ya existe el archivo de salida, si existe, saltar\n",
    "    if [ -f \"$output_dir/$salida\" ]; then\n",
    "        echo \"Archivo $salida ya existe, saltando...\"\n",
    "        continue\n",
    "    fi\n",
    "\n",
    "    # Marcar duplicados\n",
    "    \"$java\" -jar \"$picard\" MarkDuplicates \\\n",
    "         I=\"$bam_file\" \\\n",
    "         O=\"$output_dir/$salida\" \\\n",
    "         M=\"$output_dir/${salida%.bam}.metrics\" \\\n",
    "         REMOVE_DUPLICATES=true\n",
    "         \n",
    "    echo \"Duplicados marcados para ${base_name}.\"\n",
    "done\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "195f75f7-6155-4590-8c4d-e7a09441ad14",
   "metadata": {},
   "outputs": [],
   "source": [
    "###Recalibrar bases: \n",
    "\n",
    "nohup bash -c '\n",
    "\n",
    "# Definici√≥n de variables\n",
    "bam_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/OVARIO/bwa_data\"\n",
    "reference=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/hg38.fa\"\n",
    "dbsnp=\"/home/yordonez3/gatk-recursos/Homo_sapiens_assembly38.dbsnp138.vcf.gz\"\n",
    "output_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/OVARIO/bwa_data\"\n",
    "\n",
    "# Iterar sobre los archivos -noDups.bam\n",
    "for bam_file in \"${bam_dir}\"/*-noDups.bam; do\n",
    "    base_name=$(basename \"$bam_file\" -noDups.bam)\n",
    "    recal_data=\"${output_dir}/${base_name}-recal_data.table\"\n",
    "\n",
    "    # Verificar si ya existe el archivo de recalibraci√≥n\n",
    "    if [ -f \"$recal_data\" ]; then\n",
    "        echo \"El archivo $recal_data ya existe, saltando...\"\n",
    "        continue\n",
    "    fi\n",
    "\n",
    "    # Ejecutar GATK BaseRecalibrator directamente\n",
    "    /home/yordonez3/gatk-4.2.2.0/gatk BaseRecalibrator \\\n",
    "        -R \"$reference\" \\\n",
    "        -I \"$bam_file\" \\\n",
    "        --known-sites \"$dbsnp\" \\\n",
    "        -O \"$recal_data\" \\\n",
    "        --use-original-qualities\n",
    "\n",
    "    echo \"Recalibraci√≥n de bases completada para ${base_name}.\"\n",
    "done\n",
    "\n",
    "echo \"Proceso finalizado para muestras faltantes.\"\n",
    "' > recalibracion_bases.log 2>&1 &\n",
    "\n",
    "#####OTRAS MUESTARS PANEL\n",
    "\n",
    "nohup bash -c '\n",
    "\n",
    "# ==============================\n",
    "# Variables\n",
    "# ==============================\n",
    "bam_dir=\"/home/yordonez3/FastQ/Nuevo_alineamiento/BAMs\"\n",
    "reference=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/hg38.fa\"\n",
    "dbsnp=\"/home/yordonez3/gatk-recursos/Homo_sapiens_assembly38.dbsnp138.vcf.gz\"\n",
    "\n",
    "output_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/PANEL/Recalibracion_Danny\"\n",
    "mkdir -p \"$output_dir\"\n",
    "\n",
    "# ==============================\n",
    "# Loop sobre BAMs listos (con RG)\n",
    "# ==============================\n",
    "for bam_file in \"${bam_dir}\"/*_sorted_dedup_RG.bam; do\n",
    "    base_name=$(basename \"$bam_file\" _sorted_dedup_RG.bam)\n",
    "\n",
    "    recal_table=\"${output_dir}/${base_name}_recal_data.table\"\n",
    "    bam_recal=\"${output_dir}/${base_name}_recal.bam\"\n",
    "\n",
    "    # Saltar si ya existe\n",
    "    if [ -f \"$bam_recal\" ]; then\n",
    "        echo \"‚úî $bam_recal ya existe, saltando...\"\n",
    "        continue\n",
    "    fi\n",
    "\n",
    "    echo \">> Recalibrando ${base_name}...\"\n",
    "\n",
    "    # Paso 1: Crear tabla de recalibraci√≥n\n",
    "    /home/yordonez3/gatk-4.2.2.0/gatk BaseRecalibrator \\\n",
    "        -R \"$reference\" \\\n",
    "        -I \"$bam_file\" \\\n",
    "        --known-sites \"$dbsnp\" \\\n",
    "        -O \"$recal_table\" \\\n",
    "        --use-original-qualities\n",
    "\n",
    "    # Paso 2: Aplicar la recalibraci√≥n\n",
    "    /home/yordonez3/gatk-4.2.2.0/gatk ApplyBQSR \\\n",
    "        -R \"$reference\" \\\n",
    "        -I \"$bam_file\" \\\n",
    "        --bqsr-recal-file \"$recal_table\" \\\n",
    "        -O \"$bam_recal\" \\\n",
    "        --create-output-bam-index\n",
    "\n",
    "    echo \"‚úî Recalibraci√≥n completada: $bam_recal\"\n",
    "done\n",
    "\n",
    "echo \"‚úÖ Proceso finalizado para todas las muestras.\"\n",
    "\n",
    "' > recalibracion_bases.log 2>&1 &\n",
    "\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "48ca9429-b1df-41d2-b561-e8df5f1d0d54",
   "metadata": {},
   "outputs": [],
   "source": [
    "### BQSR.bam\n",
    "\n",
    "nohup bash -c '\n",
    "\n",
    "# Definici√≥n de variables\n",
    "bam_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/\"\n",
    "reference=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/hg38.fa\"\n",
    "output_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/OVARIO/bwa_data\"\n",
    "\n",
    "# Iterar sobre los archivos -noDups.bam\n",
    "for bam_file in \"${bam_dir}\"/*-noDups.bam; do\n",
    "    base_name=$(basename \"$bam_file\" -noDups.bam)\n",
    "    recal_data=\"${output_dir}/${base_name}-recal_data.table\"\n",
    "    output_bam=\"${output_dir}/${base_name}-BQSR.bam\"\n",
    "\n",
    "    # Verificar si ya se aplic√≥ la recalibraci√≥n\n",
    "    if [ -f \"$output_bam\" ]; then\n",
    "        echo \"El archivo $output_bam ya existe, saltando...\"\n",
    "        continue\n",
    "    fi\n",
    "\n",
    "    # Verificar si existe el archivo de recalibraci√≥n\n",
    "    if [ ! -f \"$recal_data\" ]; then\n",
    "        echo \"Falta el archivo $recal_data. No se puede aplicar BQSR a ${base_name}, saltando...\"\n",
    "        continue\n",
    "    fi\n",
    "\n",
    "    # Ejecutar ApplyBQSR\n",
    "    /home/yordonez3/gatk-4.2.2.0/gatk ApplyBQSR \\\n",
    "        -R \"$reference\" \\\n",
    "        -I \"$bam_file\" \\\n",
    "        --bqsr-recal-file \"$recal_data\" \\\n",
    "        -O \"$output_bam\"\n",
    "\n",
    "    echo \"Aplicada recalibraci√≥n a ${base_name}, generado: ${output_bam}\"\n",
    "done\n",
    "\n",
    "echo \"Proceso finalizado para aplicar recalibraci√≥n.\"\n",
    "' > aplicar_bqsr.log 2>&1 &\n",
    "\n",
    "#REVISAR: \n",
    "tail -f  aplicar_bqsr.log\n",
    "\n",
    "#!/bin/bash\n",
    "\n",
    "# con las muestras del PANEL\n",
    "REFERENCE=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/hg38.fa\"\n",
    "\n",
    "for bam in *_recal.bam; do\n",
    "    sample=$(basename \"$bam\" _recal.bam)\n",
    "    table=\"${sample}_recal_data.table\"\n",
    "\n",
    "    if [[ -f \"$table\" ]]; then\n",
    "        echo \">> Aplicando BQSR a $bam ...\"\n",
    "        gatk ApplyBQSR \\\n",
    "            -R $REFERENCE \\\n",
    "            -I \"$bam\" \\\n",
    "            --bqsr-recal-file \"$table\" \\\n",
    "            -O \"${sample}_recalibrated.bam\"\n",
    "    else\n",
    "        echo \"!! No encontr√© el recal_data.table para $sample, lo salto...\"\n",
    "    fi\n",
    "done"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3c37e01f-ddc3-4b47-b373-b3c2e1d222ea",
   "metadata": {},
   "outputs": [],
   "source": [
    "##LLAMADO DE VARIANTES GERMINALES-HAPLOTYPE CALLER\n",
    "\n",
    "#####si se para la corrida de varianets germianles\n",
    "reference=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/hg38.fa\"\n",
    "bam_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES\"\n",
    "output_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES/gvcfs\"\n",
    "dbsnp_file=\"/home/yordonez3/gatk-recursos/Homo_sapiens_assembly38.dbsnp138.vcf.gz\"\n",
    "gatk_jar=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/gatk-4.6.1.0/gatk-package-4.6.1.0-local.jar\"\n",
    "num_threads=14\n",
    "\n",
    "mkdir -p \"$output_dir\"\n",
    "\n",
    "log_file=\"$output_dir/gvcf_calling_errors.log\"\n",
    "> \"$log_file\"  # Limpia log anterior\n",
    "\n",
    "for bam_file in \"$bam_dir\"/*-BQSR.bam; do\n",
    "  sample_name=$(basename \"$bam_file\" -BQSR.bam)\n",
    "  output_gvcf=\"$output_dir/${sample_name}.g.vcf.gz\"\n",
    "\n",
    "  # Validar existencia del BAM\n",
    "  if [[ ! -f \"$bam_file\" ]]; then\n",
    "    echo \"‚ùå BAM no encontrado para $sample_name, se omite.\" | tee -a \"$log_file\"\n",
    "    continue\n",
    "  fi\n",
    "\n",
    "  # Validar si ya existe el GVCF y no est√° vac√≠o\n",
    "  if [[ -s \"$output_gvcf\" ]]; then\n",
    "    echo \"‚úÖ GVCF ya existe y no est√° vac√≠o para $sample_name, se omite.\"\n",
    "    continue\n",
    "  fi\n",
    "\n",
    "  echo \"üîÑ Procesando $sample_name...\"\n",
    "\n",
    "  if java -Xmx35g -jar \"$gatk_jar\" HaplotypeCaller \\\n",
    "    -R \"$reference\" \\\n",
    "    -I \"$bam_file\" \\\n",
    "    -O \"$output_gvcf\" \\\n",
    "    -ERC GVCF \\\n",
    "    --dbsnp \"$dbsnp_file\" \\\n",
    "    --native-pair-hmm-threads \"$num_threads\"; then\n",
    "    echo \"‚úÖ HaplotypeCaller completado para $sample_name.\"\n",
    "  else\n",
    "    echo \"‚ùå Error en HaplotypeCaller para $sample_name\" | tee -a \"$log_file\"\n",
    "    # Elimina output corrupto si se cre√≥\n",
    "    [[ -f \"$output_gvcf\" ]] && rm -f \"$output_gvcf\"\n",
    "  fi\n",
    "done\n",
    "\n",
    "##para revisar que todos tienen su indice tbi:\n",
    "for f in *.g.vcf.gz; do\n",
    "    if [[ -f \"$f.tbi\" ]]; then\n",
    "        echo \"‚úÖ √çndice OK: $f.tbi\"\n",
    "    else\n",
    "        echo \"‚ùå Falta √≠ndice para: $f\"\n",
    "    fi\n",
    "done\n",
    "\n",
    "####Segun GPT para las muestars faltantes del PANEL:\n",
    "#!/bin/bash\n",
    "\n",
    "GATK=\"/home/yordonez3/gatk-4.2.2.0/gatk\"\n",
    "REFERENCE=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/hg38.fa\"\n",
    "\n",
    "for bam in *_recalibrated.bam; do\n",
    "    sample=$(basename \"$bam\" _recalibrated.bam)\n",
    "    gvcf=\"${sample}.g.vcf.gz\"\n",
    "\n",
    "    echo \">> Llamando variantes para $bam ...\"\n",
    "\n",
    "    $GATK HaplotypeCaller \\\n",
    "        -R $REFERENCE \\\n",
    "        -I \"$bam\" \\\n",
    "        -O \"$gvcf\" \\\n",
    "        -ERC GVCF\n",
    "done"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0ed7699e-236b-4212-8da7-914092c4a139",
   "metadata": {},
   "outputs": [],
   "source": [
    "###GENOMIC DBS IMPORT:\n",
    "\n",
    "#####Si tengo mis vcfs:\n",
    "#!/bin/bash\n",
    "\n",
    "reference=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/hg38.fa\"\n",
    "output_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES/gvcfs\"\n",
    "gvcf_dir=\"$output_dir\"\n",
    "tmp_dir=\"$gvcf_dir/tmp\"\n",
    "mkdir -p \"$tmp_dir\"\n",
    "\n",
    "gatk=( \"$HOME/miniconda3/bin/java\" -jar /home/yordonez3/gatk-4.2.2.0/gatk-package-4.2.2.0-local.jar )\n",
    "\n",
    "# Verifica permisos tmp_dir\n",
    "if [ ! -r \"$tmp_dir\" ] || [ ! -w \"$tmp_dir\" ]; then\n",
    "  echo \"‚ùå No tienes permisos de lectura/escritura en $tmp_dir\"\n",
    "  exit 1\n",
    "fi\n",
    "\n",
    "# Archivos gVCF\n",
    "gvcf_files=(\"$gvcf_dir\"/*.g.vcf.gz)\n",
    "if [ ! -e \"${gvcf_files[0]}\" ]; then\n",
    "  echo \"‚ö†Ô∏è No se encontraron archivos .g.vcf.gz en $gvcf_dir\"\n",
    "  exit 1\n",
    "fi\n",
    "\n",
    "echo \"üîé Se encontraron ${#gvcf_files[@]} muestras para importar.\"\n",
    "\n",
    "# Construcci√≥n arreglo inputs\n",
    "inputs=()\n",
    "for file in \"${gvcf_files[@]}\"; do\n",
    "  inputs+=( -V \"$file\" )\n",
    "done\n",
    "\n",
    "chromosomes=(chr{1..22} chrX chrY)\n",
    "\n",
    "for chr in \"${chromosomes[@]}\"; do\n",
    "  workspace_path=\"$output_dir/my_database_$chr\"\n",
    "  if [ -d \"$workspace_path\" ]; then\n",
    "    echo \"‚úÖ $chr ya fue procesado. Omitiendo...\"\n",
    "  else\n",
    "    echo \"üöÄ Procesando $chr ...\"\n",
    "    \"${gatk[@]}\" GenomicsDBImport \\\n",
    "      \"${inputs[@]}\" \\\n",
    "      --genomicsdb-workspace-path \"$workspace_path\" \\\n",
    "      --tmp-dir \"$tmp_dir\" \\\n",
    "      --intervals \"$chr\"\n",
    "\n",
    "    if [ $? -eq 0 ]; then\n",
    "      echo \"‚úÖ $chr importado correctamente.\"\n",
    "    else\n",
    "      echo \"‚ùå Error al importar $chr.\"\n",
    "      exit 1\n",
    "    fi\n",
    "  fi\n",
    "done\n",
    "\n",
    "echo \"üéâ Proceso completo.\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f009eda0-4140-4431-b326-325267e0def6",
   "metadata": {},
   "outputs": [],
   "source": [
    "### GENOTIPIFICACI√ìN:\n",
    "\n",
    "reference=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/hg38.fa\"\n",
    "base_path=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/PANEL/\"\n",
    "\n",
    "for db in ${base_path}/my_database_c*; do\n",
    "  gatk GenotypeGVCFs \\\n",
    "    -R \"$reference\" \\\n",
    "    -V gendb://\"$db\" \\\n",
    "    -O \"genotipos_${chr}.vcf.gz\"\n",
    "done\n",
    "\n",
    "# Ver el archivo VCF y contar variantes\n",
    "bcftools view genotipos_chr1.vcf.gz | head -n 20\n",
    "bcftools view -H -v snps genotipos_chr1.vcf.gz | wc -l\n",
    "\n",
    "##### SI FALTAN MUESTRAS:\n",
    "\n",
    "reference=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/hg38.fa\"\n",
    "base_path=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES/gvcfs\"\n",
    "output_dir=\"$base_path\"\n",
    "\n",
    "for db in ${base_path}/my_database_chr*; do\n",
    "  chr=$(basename \"$db\" | sed 's/my_database_//')\n",
    "  output_file=\"${output_dir}/genotipos_${chr}.vcf.gz\"\n",
    "\n",
    "  if [[ -f \"$output_file\" ]]; then\n",
    "    echo \"Archivo $output_file ya existe, saltando cromosoma $chr.\"\n",
    "    continue\n",
    "  fi\n",
    "\n",
    "  echo \"Procesando cromosoma $chr ...\"\n",
    "\n",
    "  gatk GenotypeGVCFs \\\n",
    "    -R \"$reference\" \\\n",
    "    -V gendb://\"$db\" \\\n",
    "    -O \"$output_file\"\n",
    "done\n",
    "\n",
    "##### Verificar que los archivos no est√©n corruptos\n",
    "bash\n",
    "Copiar\n",
    "Editar\n",
    "for f in genotipos_chr*.vcf.gz; do\n",
    "  gzip -t \"$f\" && echo \"$f OK\" || echo \"$f CORRUPTO\"\n",
    "done\n",
    "##### Contar el n√∫mero de variantes (l√≠neas no header) para ver que no est√©n vac√≠os\n",
    "for f in genotipos_chr*.vcf.gz; do\n",
    "  echo -n \"$f: \"\n",
    "  bcftools view -H \"$f\" | wc -l\n",
    "done"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "74f0e003-e723-4d35-8e62-e6841605a52b",
   "metadata": {},
   "outputs": [],
   "source": [
    "####PLINK\n",
    "\n",
    "bcftools view --no-header genotipos_chr*_filtered.vcf.gz | head\n",
    "\n",
    "##1. Generar los bfiles con el archivo .vcf de mis muestras\n",
    "The first step for quality control (QC) analysis in PLINK starting from\n",
    "your VCF files is to convert the VCF file to PLINK format (BED, BIM, FAM).\n",
    "PLINK provides a tool called plink2 for this purpose. \n",
    "                                 \n",
    "#######plink --vcf genotipos_chr*.vcf.gz --make-bed --out geno_plink\n",
    "for chr in {1..22} X; do\n",
    "  plink --vcf genotipos_chr${chr}_filtered.vcf.gz --make-bed --out geno_chr${chr} --double-id\n",
    "done\n",
    "\n",
    "#Results\n",
    "geno_chr10.log:240659 variants and 14 people pass filters and QC.\n",
    "geno_chr11.log:254403 variants and 14 people pass filters and QC.\n",
    "geno_chr12.log:250521 variants and 14 people pass filters and QC.\n",
    "geno_chr13.log:162527 variants and 14 people pass filters and QC.\n",
    "\n",
    "geno_chr10.log:Total genotyping rate is 0.484702.\n",
    "geno_chr11.log:Total genotyping rate is 0.518062.\n",
    "geno_chr12.log:Total genotyping rate is 0.509932.\n",
    "geno_chr13.log:Total genotyping rate is 0.492483.\n",
    "\n",
    "#Usar comando geno 0.1 para que deje solamente SNPs con CR>90%\n",
    "plink --bfile geno_plink --geno 0.1  --make-bed --out geno_plink_fil1\n",
    "\n",
    "#Control de calidad para individuos con mind. Deja solamente casos CR>90%\n",
    "plink --bfile geno_plink_fil1 --mind 0.25 --make-bed --out geno_plink_fil2   ##Mejor hacerlo con 0.1 despues\n",
    "\n",
    "#MAF: 0.01 remueve variantes con frecuencia de alelo menor a 1% (es dcir mutaciones y demas)\n",
    "plink --bfile geno_plink_fil2 --maf 0.01 --make-bed --out geno_plink_fil3\n",
    "\n",
    "#HW\n",
    "plink --bfile geno_plink_fil3 --hwe 1e-6 --hwe-all --make-bed --out geno_plink_fil4"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6be5669b-9e55-43c6-8e31-255a65be67d6",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Perform LD pruning in two steps:\n",
    "# Step 1: Generate list of SNPs to keep\n",
    "# We perform linkage disequilibrium (LD) pruning using:\n",
    "  # - a window size of 50 SNPs\n",
    "  # - a step size of 5 SNPs\n",
    "  # - r2 threshold of 0.2 (correlation between SNPs)\n",
    "\n",
    "plink --bfile geno_plink_fil4 --indep-pairwise 50 5 0.2 --out ld_pruned\n",
    "\n",
    "#Results \n",
    "Total genotyping rate is 0.944005.\n",
    "1.963.959 variants and 17 people pass filters and QC.\n",
    "Pruning complete.  1.668.064 of 1.963.959 variants removed.\n",
    "\n",
    "\n",
    "# Step 2: Apply LD pruning\n",
    "plink --bfile geno_plink_fil4 --extract ld_pruned.prune.in --make-bed --out geno_plink_fil5\n",
    "\n",
    "#Results \n",
    "57852 variants and 14 people pass filters and QC.\n",
    "14 people \n",
    "Total genotyping rate is 0.981108."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "8da1b888-7773-43e2-bbaf-63fdf8e49a1d",
   "metadata": {},
   "outputs": [],
   "source": [
    "################### PASOS LLAMADO DE VARIANTES SOMATICAS ###################"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "7b4d3400-6901-4b71-9b1e-0d8b62d95b1e",
   "metadata": {},
   "outputs": [
    {
     "ename": "SyntaxError",
     "evalue": "invalid syntax (2982783393.py, line 13)",
     "output_type": "error",
     "traceback": [
      "\u001b[0;36m  Cell \u001b[0;32mIn[1], line 13\u001b[0;36m\u001b[0m\n\u001b[0;31m    > \"$tmp_log\"\u001b[0m\n\u001b[0m    ^\u001b[0m\n\u001b[0;31mSyntaxError\u001b[0m\u001b[0;31m:\u001b[0m invalid syntax\n"
     ]
    }
   ],
   "source": [
    "## LLAMADO DE VARIANTES SOMATICAS:\n",
    "\n",
    "input_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES\"\n",
    "\n",
    "# Directorio de salida para las variantes som√°ticas\n",
    "output_dir=\"$input_dir\"\n",
    "\n",
    "# Genoma de referencia\n",
    "reference=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/hg38.fa\"\n",
    "\n",
    "# Archivo de log para errores\n",
    "tmp_log=\"${output_dir}/mutect2_errores.log\"\n",
    "> \"$tmp_log\"\n",
    "\n",
    "# Detectar muestras desde BAMs \"-BQSR.bam\"\n",
    "samples=( $(ls \"${input_dir}\"/*-BQSR.bam | xargs -n1 basename | sed 's/-BQSR.bam//') )\n",
    "\n",
    "for sample_name in \"${samples[@]}\"; do\n",
    "  input_bam=\"${input_dir}/${sample_name}-BQSR.bam\"\n",
    "  output_vcf=\"${output_dir}/${sample_name}_somatic.vcf.gz\"\n",
    "  output_tbi=\"${output_vcf}.tbi\"\n",
    "  output_stats=\"${output_vcf}.stats\"\n",
    "\n",
    "  # Saltar si ya existe VCF, TBI y STATS no vac√≠os\n",
    "  if [[ -s \"$output_vcf\" && -s \"$output_tbi\" && -s \"$output_stats\" ]]; then\n",
    "    echo \"‚úÖ Ya procesado: $sample_name ‚Äî archivos de salida presentes.\"\n",
    "    continue\n",
    "  fi\n",
    "\n",
    "  echo \"üîÑ Ejecutando Mutect2 para $sample_name...\"\n",
    "\n",
    "  if gatk Mutect2 \\\n",
    "      -R \"$reference\" \\\n",
    "      -I \"$input_bam\" \\\n",
    "      -O \"$output_vcf\" \\\n",
    "      --native-pair-hmm-threads 14 \\\n",
    "      -L chr1 -L chr2 -L chr3 -L chr4 -L chr5 \\\n",
    "      -L chr6 -L chr7 -L chr8 -L chr9 -L chr10 \\\n",
    "      -L chr11 -L chr12 -L chr13 -L chr14 -L chr15 \\\n",
    "      -L chr16 -L chr17 -L chr18 -L chr19 -L chr20 \\\n",
    "      -L chr21 -L chr22 -L chrX -L chrY; then\n",
    "\n",
    "    # Crear archivos de √≠ndice y stats si no se generaron autom√°ticamente\n",
    "    [[ ! -s \"$output_tbi\" ]] && samtools index \"$output_vcf\"\n",
    "    [[ ! -s \"$output_stats\" ]] && touch \"$output_stats\"\n",
    "\n",
    "    echo \"‚úÖ Mutect2 completado para $sample_name\"\n",
    "  else\n",
    "    echo \"‚ùå Error en $sample_name. Revisa $input_bam o $reference\" | tee -a \"$tmp_log\"\n",
    "    [[ -f \"$output_vcf\" ]] && rm -f \"$output_vcf\"\n",
    "  fi\n",
    "done\n",
    "\n",
    "##### Para correr en segundo plano:\n",
    "\n",
    "nohup bash -c '\n",
    "# Variables\n",
    "input_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES\"\n",
    "output_dir=\"$input_dir\"\n",
    "reference=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/hg38.fa\"\n",
    "gatk=\"java -jar /home/yordonez3/gatk-4.2.2.0/gatk-package-4.2.2.0-local.jar\"\n",
    "\n",
    "# Muestras espec√≠ficas\n",
    "samples=(\"CO-H_298351_all\" \"CO-H_298454_all\" \"CO-H_302244_all\")\n",
    "\n",
    "for sample_name in \"${samples[@]}\"; do\n",
    "  input_bam=\"${input_dir}/${sample_name}-BQSR.bam\"\n",
    "  output_vcf=\"${output_dir}/${sample_name}_somatic.vcf.gz\"\n",
    "  output_tbi=\"${output_vcf}.tbi\"\n",
    "  output_stats=\"${output_vcf}.stats\"\n",
    "\n",
    "  if [[ -s \"$output_vcf\" && -s \"$output_tbi\" && -s \"$output_stats\" ]]; then\n",
    "    echo \"‚úÖ Ya procesado: $sample_name\"\n",
    "    continue\n",
    "  fi\n",
    "\n",
    "  echo \"üîÑ Ejecutando Mutect2 para $sample_name...\"\n",
    "\n",
    "  if $gatk Mutect2 \\\n",
    "      -R \"$reference\" \\\n",
    "      -I \"$input_bam\" \\\n",
    "      -O \"$output_vcf\" \\\n",
    "      --native-pair-hmm-threads 14 \\\n",
    "      -L chr1 -L chr2 -L chr3 -L chr4 -L chr5 \\\n",
    "      -L chr6 -L chr7 -L chr8 -L chr9 -L chr10 \\\n",
    "      -L chr11 -L chr12 -L chr13 -L chr14 -L chr15 \\\n",
    "      -L chr16 -L chr17 -L chr18 -L chr19 -L chr20 \\\n",
    "      -L chr21 -L chr22 -L chrX -L chrY; then\n",
    "\n",
    "    [[ ! -s \"$output_tbi\" ]] && samtools index \"$output_vcf\"\n",
    "    [[ ! -s \"$output_stats\" ]] && touch \"$output_stats\"\n",
    "\n",
    "    echo \"‚úÖ Mutect2 completado para $sample_name\"\n",
    "  else\n",
    "    echo \"‚ùå Error en $sample_name. Revisa $input_bam o $reference\"\n",
    "    [[ -f \"$output_vcf\" ]] && rm -f \"$output_vcf\"\n",
    "  fi\n",
    "done\n",
    "' > mutect2_llamado_especifico.log 2>&1 &\n",
    "\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e00d166d-d08e-4b63-a139-5753dcb229f9",
   "metadata": {},
   "outputs": [],
   "source": [
    "#####COSMIC\n",
    "scp \"C:/Users/pmorales/Downloads/Cosmic_GenomeScreensMutant_Vcf_v102_GRCh38.tar\" yordonez3@130.207.66.26:/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES/Mutect2_filtered/normalized/annovar\n",
    "scp \"C:/Users/pmorales/Downloads/Cosmic_GenomeScreensMutant_Tsv_v102_GRCh38.tar\" yordonez3@130.207.66.26:/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES/Mutect2_filtered/normalized/annovar"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "73d7c982-0641-49ea-87f5-6522d2a65265",
   "metadata": {},
   "outputs": [],
   "source": [
    "##### Filtrado de variantes somaticas \n",
    "\n",
    "input_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES\"\n",
    "filtered_output_dir=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES/Mutect2_filtered\"\n",
    "reference=\"/home/yordonez3/Danny_OV_WES/concatenated_fastq/concatenated_all_fastq/hg38.fa\"\n",
    "\n",
    "# Crear el directorio de salida si no existe\n",
    "mkdir -p \"$filtered_output_dir\"\n",
    "\n",
    "# Obtener los nombres de las muestras basados en los archivos VCF sin filtrar de Mutect2\n",
    "samples=($(ls \"${input_dir}\"/*.vcf.gz | xargs -n 1 basename | sed 's/.vcf.gz//'))\n",
    "\n",
    "# Loop para procesar cada muestra con FilterMutectCalls\n",
    "for sample_name in \"${samples[@]}\"; do\n",
    "    unfiltered_vcf=\"${input_dir}/${sample_name}.vcf.gz\"\n",
    "    filtered_vcf=\"${filtered_output_dir}/${sample_name}_filtered.vcf.gz\"\n",
    "\n",
    "    # Revisar si ya existe el archivo filtrado\n",
    "    if [ -f \"$filtered_vcf\" ]; then\n",
    "        echo \"‚è© Ya existe $filtered_vcf, saltando...\"\n",
    "        continue\n",
    "    fi\n",
    "\n",
    "    # Ejecutar FilterMutectCalls\n",
    "    echo \"üö¶ Procesando $sample_name...\"\n",
    "    gatk FilterMutectCalls \\\n",
    "        -V \"$unfiltered_vcf\" \\\n",
    "        -R \"$reference\" \\\n",
    "        -O \"$filtered_vcf\"\n",
    "\n",
    "    echo \"‚úÖ FilterMutectCalls completado para la muestra $sample_name\"\n",
    "done\n",
    "\n",
    "#PARA REVISAR QUE LAS MUESTRAS QUEDARON BIEN FILTRADAS:\n",
    "\n",
    "cd /home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES/Mutect2_filtered\n",
    "\n",
    "for f in *.vcf.gz; do\n",
    "    if gzip -t \"$f\" 2>/dev/null; then\n",
    "        echo \"‚úÖ $f OK\"\n",
    "    else\n",
    "        echo \"‚ùå $f CORRUPTO\"\n",
    "    fi\n",
    "done"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "fc31f56e-4d54-44a4-99cc-cb860f389462",
   "metadata": {},
   "outputs": [],
   "source": [
    "## Anotacion ANNOVAR (DESCARGAR PRIMERO LAS BDS ENCESARIAS)\n",
    "\n",
    "1. Descomprime el TSV (lo necesitaremos sin compresi√≥n)\n",
    "gunzip -f GenomeScreensMutant_Tsv_v102_GRCh38.tsv.gz\n",
    "# Ahora tienes: GenomeScreensMutant_Tsv_v102_GRCh38.tsv\n",
    "\n",
    "# 2. Reconstruye tu archivo ANNOVAR\n",
    "echo -e \"#Chr\\tStart\\tEnd\\tRef\\tAlt\\tCOSMIC102\" > hg38_cosmic102.txt\n",
    "\n",
    "# 3. Lanza prepare_annovar_user.pl con el TSV descomprimido y el VCF\n",
    "/home/yordonez3/Danny_OV_WES/concatenated_fastq/VARIANTES/Mutect2_filtered/normalized/annovar/prepare_annovar_user.pl \\\n",
    "    -dbtype cosmic \\\n",
    "    Cosmic_GenomeScreensMutant_v102_GRCh38.tsv \\\n",
    "    -vcf Cosmic_GenomeScreensMutant_v102_GRCh38.vcf.gz \\\n",
    "  >> hg38_cosmic102.txt\n",
    "\n",
    "# 4. Opcional: comprueba las primeras l√≠neas\n",
    "head hg38_cosmic102.txt\n",
    "\n",
    "# 5. (Opcional) Indexa para b√∫squedas r√°pidas\n",
    "perl index_annovar.pl hg38_cosmic102.txt -outfile hg38_cosmic102"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "78c10e78-b4d4-454a-ba8b-9098d20591f2",
   "metadata": {},
   "outputs": [],
   "source": [
    "####PLINK\n",
    "1. Convertir cada VCF por cromosoma a PLINK (BED):\n",
    "\n",
    "for chr in {1..22} X; do\n",
    "  plink2 --vcf genotipos_chr${chr}_filtered.vcf.gz --make-bed --out geno_chr${chr} --double-id\n",
    "done\n",
    "\n",
    "####--double-id para evitar problemas con IDs repetidos, asigna FID=IID.\n",
    "####plink2 es m√°s recomendado para VCF, pero plink cl√°sico tambi√©n puede funcionar.\n",
    "\n",
    "2. \n",
    "\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "anaconda-panel-2023.05-py310",
   "language": "python",
   "name": "conda-env-anaconda-panel-2023.05-py310-py"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
